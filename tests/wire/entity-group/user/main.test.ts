/**
 * This file was auto-generated by Fern from our API Definition.
 */

import { mockServerPool } from "../../../mock-server/MockServerPool";
import { MercoaClient } from "../../../../src/Client";

describe("User", () => {
    test("find", async () => {
        const server = mockServerPool.createServer();
        const client = new MercoaClient({ token: "test", xApiVersion: "2024-08-01", environment: server.baseUrl });

        const rawResponseBody = {
            count: 1,
            hasMore: false,
            data: [
                {
                    foreignId: "MY-DB-ID-12345",
                    email: "john.doe@acme.com",
                    name: "John Doe",
                    entities: [
                        {
                            id: "user_ec3aafc8-ea86-408a-a6c1-545497badbbb",
                            roles: ["admin", "approver"],
                            entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d",
                        },
                        {
                            id: "user_3a3aafc8-ea86-408a-a6c1-545497badbbb",
                            roles: ["viewer"],
                            entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90",
                        },
                    ],
                    createdAt: "2024-01-01T00:00:00Z",
                    updatedAt: "2024-01-01T00:00:00Z",
                },
            ],
        };
        server
            .mockEndpoint()
            .get("/entityGroup/entg_8545a84e-a45f-41bf-bdf1-33b42a55812c/users")
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.entityGroup.user.find("entg_8545a84e-a45f-41bf-bdf1-33b42a55812c", {
            name: "John",
        });
        expect(response).toEqual({
            count: 1,
            hasMore: false,
            data: [
                {
                    foreignId: "MY-DB-ID-12345",
                    email: "john.doe@acme.com",
                    name: "John Doe",
                    entities: [
                        {
                            id: "user_ec3aafc8-ea86-408a-a6c1-545497badbbb",
                            roles: ["admin", "approver"],
                            entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d",
                        },
                        {
                            id: "user_3a3aafc8-ea86-408a-a6c1-545497badbbb",
                            roles: ["viewer"],
                            entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90",
                        },
                    ],
                    createdAt: new Date("2024-01-01T00:00:00.000Z"),
                    updatedAt: new Date("2024-01-01T00:00:00.000Z"),
                },
            ],
        });
    });

    test("create", async () => {
        const server = mockServerPool.createServer();
        const client = new MercoaClient({ token: "test", xApiVersion: "2024-08-01", environment: server.baseUrl });
        const rawRequestBody = {
            foreignId: "MY-DB-ID-12345",
            email: "john.doe@acme.com",
            name: "John Doe",
            entities: [
                { roles: ["admin", "approver"], entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d" },
                { roles: ["viewer"], entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90" },
            ],
        };
        const rawResponseBody = {
            foreignId: "MY-DB-ID-12345",
            email: "john.doe@acme.com",
            name: "John Doe",
            entities: [
                {
                    id: "user_ec3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["admin", "approver"],
                    entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d",
                },
                {
                    id: "user_3a3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["viewer"],
                    entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90",
                },
            ],
            createdAt: "2024-01-01T00:00:00Z",
            updatedAt: "2024-01-01T00:00:00Z",
        };
        server
            .mockEndpoint()
            .post("/entityGroup/entg_8545a84e-a45f-41bf-bdf1-33b42a55812c/user")
            .jsonBody(rawRequestBody)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.entityGroup.user.create("entg_8545a84e-a45f-41bf-bdf1-33b42a55812c", {
            foreignId: "MY-DB-ID-12345",
            email: "john.doe@acme.com",
            name: "John Doe",
            entities: [
                {
                    roles: ["admin", "approver"],
                    entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d",
                },
                {
                    roles: ["viewer"],
                    entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90",
                },
            ],
        });
        expect(response).toEqual({
            foreignId: "MY-DB-ID-12345",
            email: "john.doe@acme.com",
            name: "John Doe",
            entities: [
                {
                    id: "user_ec3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["admin", "approver"],
                    entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d",
                },
                {
                    id: "user_3a3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["viewer"],
                    entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90",
                },
            ],
            createdAt: new Date("2024-01-01T00:00:00.000Z"),
            updatedAt: new Date("2024-01-01T00:00:00.000Z"),
        });
    });

    test("get", async () => {
        const server = mockServerPool.createServer();
        const client = new MercoaClient({ token: "test", xApiVersion: "2024-08-01", environment: server.baseUrl });

        const rawResponseBody = {
            foreignId: "MY-DB-ID-12345",
            email: "john.doe@acme.com",
            name: "John Doe",
            entities: [
                {
                    id: "user_ec3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["admin", "approver"],
                    entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d",
                },
                {
                    id: "user_3a3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["viewer"],
                    entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90",
                },
            ],
            createdAt: "2024-01-01T00:00:00Z",
            updatedAt: "2024-01-01T00:00:00Z",
        };
        server
            .mockEndpoint()
            .get("/entityGroup/entg_8545a84e-a45f-41bf-bdf1-33b42a55812c/user/MY-DB-ID-12345")
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.entityGroup.user.get(
            "entg_8545a84e-a45f-41bf-bdf1-33b42a55812c",
            "MY-DB-ID-12345",
        );
        expect(response).toEqual({
            foreignId: "MY-DB-ID-12345",
            email: "john.doe@acme.com",
            name: "John Doe",
            entities: [
                {
                    id: "user_ec3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["admin", "approver"],
                    entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d",
                },
                {
                    id: "user_3a3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["viewer"],
                    entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90",
                },
            ],
            createdAt: new Date("2024-01-01T00:00:00.000Z"),
            updatedAt: new Date("2024-01-01T00:00:00.000Z"),
        });
    });

    test("update", async () => {
        const server = mockServerPool.createServer();
        const client = new MercoaClient({ token: "test", xApiVersion: "2024-08-01", environment: server.baseUrl });
        const rawRequestBody = {
            foreignId: "MY-DB-ID-12345",
            email: "john.doe@acme.com",
            name: "John Doe",
            entities: [
                { roles: ["admin", "approver"], entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d" },
                { roles: ["viewer"], entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90" },
            ],
        };
        const rawResponseBody = {
            foreignId: "MY-DB-ID-12345",
            email: "john.doe@acme.com",
            name: "John Doe",
            entities: [
                {
                    id: "user_ec3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["admin", "approver"],
                    entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d",
                },
                {
                    id: "user_3a3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["viewer"],
                    entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90",
                },
            ],
            createdAt: "2024-01-01T00:00:00Z",
            updatedAt: "2024-01-01T00:00:00Z",
        };
        server
            .mockEndpoint()
            .post("/entityGroup/entg_8545a84e-a45f-41bf-bdf1-33b42a55812c/user/MY-DB-ID-12345")
            .jsonBody(rawRequestBody)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.entityGroup.user.update(
            "entg_8545a84e-a45f-41bf-bdf1-33b42a55812c",
            "MY-DB-ID-12345",
            {
                foreignId: "MY-DB-ID-12345",
                email: "john.doe@acme.com",
                name: "John Doe",
                entities: [
                    {
                        roles: ["admin", "approver"],
                        entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d",
                    },
                    {
                        roles: ["viewer"],
                        entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90",
                    },
                ],
            },
        );
        expect(response).toEqual({
            foreignId: "MY-DB-ID-12345",
            email: "john.doe@acme.com",
            name: "John Doe",
            entities: [
                {
                    id: "user_ec3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["admin", "approver"],
                    entityId: "ent_21661ac1-a2a8-4465-a6c0-64474ba8181d",
                },
                {
                    id: "user_3a3aafc8-ea86-408a-a6c1-545497badbbb",
                    roles: ["viewer"],
                    entityId: "ent_9e02a20e-7749-47de-8d8a-f8ff2859fa90",
                },
            ],
            createdAt: new Date("2024-01-01T00:00:00.000Z"),
            updatedAt: new Date("2024-01-01T00:00:00.000Z"),
        });
    });

    test("delete", async () => {
        const server = mockServerPool.createServer();
        const client = new MercoaClient({ token: "test", xApiVersion: "2024-08-01", environment: server.baseUrl });

        server.mockEndpoint().delete("/entityGroup/entityGroupId/user/foreignId").respondWith().statusCode(200).build();

        const response = await client.entityGroup.user.delete("entityGroupId", "foreignId");
        expect(response).toEqual(undefined);
    });

    test("getToken", async () => {
        const server = mockServerPool.createServer();
        const client = new MercoaClient({ token: "test", xApiVersion: "2024-08-01", environment: server.baseUrl });
        const rawRequestBody = { expiresIn: "1h" };
        const rawResponseBody =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTIzNDU2Nzg5LCJuYW1lIjoiSm9zZXBoIn0.OpOSSw7e485LOP5PrzScxHb7SR6sAOMRckfFwi4rp7o";
        server
            .mockEndpoint()
            .post("/entityGroup/entg_a0f6ea94-0761-4a5e-a416-3c453cb7eced/user/MY-DB-ID-12345/token")
            .jsonBody(rawRequestBody)
            .respondWith()
            .statusCode(200)
            .jsonBody(rawResponseBody)
            .build();

        const response = await client.entityGroup.user.getToken(
            "entg_a0f6ea94-0761-4a5e-a416-3c453cb7eced",
            "MY-DB-ID-12345",
            {
                expiresIn: "1h",
            },
        );
        expect(response).toEqual(
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTIzNDU2Nzg5LCJuYW1lIjoiSm9zZXBoIn0.OpOSSw7e485LOP5PrzScxHb7SR6sAOMRckfFwi4rp7o",
        );
    });

    test("sync", async () => {
        const server = mockServerPool.createServer();
        const client = new MercoaClient({ token: "test", xApiVersion: "2024-08-01", environment: server.baseUrl });
        const rawRequestBody = { filterRoles: ["approver", "viewer"] };

        server
            .mockEndpoint()
            .post("/entityGroup/entg_8545a84e-a45f-41bf-bdf1-33b42a55812c/sync-users")
            .jsonBody(rawRequestBody)
            .respondWith()
            .statusCode(200)
            .build();

        const response = await client.entityGroup.user.sync("entg_8545a84e-a45f-41bf-bdf1-33b42a55812c", {
            filterRoles: ["approver", "viewer"],
        });
        expect(response).toEqual(undefined);
    });
});
